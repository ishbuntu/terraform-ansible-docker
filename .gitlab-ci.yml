stages:
  - test
  - build
  - scan
  - deploy

variables:
  IMAGE_NAME: "myapp"
  TAG: "latest"
  DOCKER_HOST: "unix:///var/run/docker.sock"  # Force use of Unix socket

# ------------------------
# ✅ TEST STAGE
# ------------------------
test:
  stage: test
  image: python:3.11
  before_script:
    - cd docker-app
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "🔍 Running Flask tests..."
    - python -m unittest discover -s tests

# ------------------------
# ✅ BUILD STAGE (SIMPLIFIED - NO DIND!)
# ------------------------
build:
  stage: build
  image: docker:latest
  before_script:
    - cd docker-app
  script:
    - echo "🐳 Building Docker image..."
    - docker build -t $IMAGE_NAME:$TAG .

# ------------------------
# ✅ SCAN STAGE (FIXED!)
# ------------------------
scan:
  stage: scan
  image: docker:latest
  before_script:
    - cd docker-app
  script:
    - echo "🔐 Scanning Docker image for vulnerabilities..."
    - docker build -t $IMAGE_NAME:$TAG .
    - echo "📋 Listing available images..."
    - docker images
    - echo "🔍 Running Trivy scan..."
    - docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --exit-code 0 --severity HIGH,CRITICAL $IMAGE_NAME:$TAG

# ------------------------
# ✅ DEPLOY STAGE (FIXED!)
# ------------------------
deploy:
  stage: deploy
  image: alpine:latest
  only:
    - main
  before_script:
    - apk add --no-cache openssh rsync
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
  script:
    - echo "🚀 Deploying to EC2..."
    - echo "📁 Copying application files..."
    - scp -r docker-app/ ec2-user@$EC2_IP:/home/ec2-user/
    - echo "🐳 Building and running on EC2..."
    - ssh ec2-user@$EC2_IP 'cd docker-app && docker build -t myapp:latest . && docker stop portfolio-app || true && docker rm portfolio-app || true && docker run -d --name portfolio-app -p 80:5000 myapp:latest'

